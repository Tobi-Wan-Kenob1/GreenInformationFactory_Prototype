name: Upload release payload to Zenodo

on:
  workflow_dispatch:
    inputs:
      title:
        description: "Zenodo title"
        required: true
        default: "GreenInformationFactory – Processed Data, Model & Performance"
      description:
        description: "Zenodo description"
        required: true
        default: "Train/test splits, trained model(s), and evaluation figure. Raw data: 10.5281/zenodo.16256961."
      community:
        description: "Zenodo community identifier"
        required: true
        default: "biofairnet"
      creator:
        description: "Creator (Surname, Name)"
        required: true
        default: "Rosnitschek, Tobias"
      affiliation:
        description: "Affiliation"
        required: true
        default: "University of Bayreuth"
      orcid:
        description: "ORCID (leave empty if none)"
        required: true
        default: "0000-0002-4876-2536"
      keywords:
        description: "Keywords (comma-separated)"
        required: true
        default: "FAIR, machine learning, circular economy"
      license_id:
        description: "License identifier"
        required: true
        default: "MIT"
      use_sandbox:
        description: "Use Zenodo SANDBOX (recommended)"
        required: true
        default: "true"
  push:
    tags:
      - "zenodo-ul-*"

permissions:
  contents: write

jobs:
  upload:
    if: startsWith(github.ref_name, 'zenodo-ul-') || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    env:
      PAYLOAD_DIR: notebooks/release_payload
      PARAMS_JSON: "metadata/zenodo_params.json"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure jq
        run: |
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y jq
          fi

      - name: Resolve metadata inputs (support tag runs)
        id: meta
        run: |
          set -euo pipefail

          # Defaults
          TITLE_DEF="GreenInformationFactory – Processed Data, Model & Performance"
          DESC_DEF="Train/test splits, trained model(s), and evaluation figure. Raw data: 10.5281/zenodo.16256961."
          COMM_DEF="biofairnet"
          CREATOR_DEF="Rosnitschek, Tobias"
          AFFIL_DEF="University of Bayreuth"
          ORCID_DEF=""
          KW_DEF="FAIR, machine learning, circular economy"
          LIC_DEF="MIT"
          SANDBOX_DEF="true"

          # Load from params file if available
          if [ -f "${PARAMS_JSON}" ]; then
            TITLE_FILE=$(jq -r '.title // empty' "${PARAMS_JSON}")
            DESC_FILE=$(jq -r '.description // empty' "${PARAMS_JSON}")
            COMM_FILE=$(jq -r '.community // empty' "${PARAMS_JSON}")
            # support creators[0].name/affiliation/orcid
            CREATOR_FILE=$(jq -r '.creators[0].name // empty' "${PARAMS_JSON}")
            AFFIL_FILE=$(jq -r '.creators[0].affiliation // empty' "${PARAMS_JSON}")
            ORCID_FILE=$(jq -r '.creators[0].orcid // empty' "${PARAMS_JSON}")
            KW_FILE=$(jq -r '(.keywords // []) | join(", ")' "${PARAMS_JSON}")
            LIC_FILE=$(jq -r '.license // empty' "${PARAMS_JSON}")
            SBX_FILE=$(jq -r '(.use_sandbox // empty)' "${PARAMS_JSON}")
          fi

          # workflow_dispatch inputs (empty on tag)
          TITLE_IN="${{ github.event.inputs.title }}"
          DESC_IN="${{ github.event.inputs.description }}"
          COMM_IN="${{ github.event.inputs.community }}"
          CREATOR_IN="${{ github.event.inputs.creator }}"
          AFFIL_IN="${{ github.event.inputs.affiliation }}"
          ORCID_IN="${{ github.event.inputs.orcid }}"
          KW_IN="${{ github.event.inputs.keywords }}"
          LIC_IN="${{ github.event.inputs.license_id }}"
          SBX_IN="${{ github.event.inputs.use_sandbox }}"

          # precedence: inputs > file > defaults
          TITLE="${TITLE_IN:-${TITLE_FILE:-$TITLE_DEF}}"
          DESC="${DESC_IN:-${DESC_FILE:-$DESC_DEF}}"
          COMM="${COMM_IN:-${COMM_FILE:-$COMM_DEF}}"
          CREATOR="${CREATOR_IN:-${CREATOR_FILE:-$CREATOR_DEF}}"
          AFFIL="${AFFIL_IN:-${AFFIL_FILE:-$AFFIL_DEF}}"
          ORCID="${ORCID_IN:-${ORCID_FILE:-$ORCID_DEF}}"
          KWCSV="${KW_IN:-${KW_FILE:-$KW_DEF}}"
          LIC="${LIC_IN:-${LIC_FILE:-$LIC_DEF}}"
          # Making Notebook editing the single switch
          #SBX="${SBX_IN:-${SBX_FILE:-$SANDBOX_DEF}}"
          SBX="${SBX_FILE:-${SBX_IN:-$SANDBOX_DEF}}"

          echo "title=$TITLE"       >> $GITHUB_OUTPUT
          echo "description=$DESC"  >> $GITHUB_OUTPUT
          echo "community=$COMM"    >> $GITHUB_OUTPUT
          echo "creator=$CREATOR"   >> $GITHUB_OUTPUT
          echo "affiliation=$AFFIL" >> $GITHUB_OUTPUT
          echo "orcid=$ORCID"       >> $GITHUB_OUTPUT
          echo "keywords_csv=$KWCSV">> $GITHUB_OUTPUT
          echo "license=$LIC"       >> $GITHUB_OUTPUT
          echo "use_sandbox=$SBX"   >> $GITHUB_OUTPUT

      - name: Debug resolved sandbox + params file
        shell: bash
        run:  |
          set -euo pipefail
          echo "PARAMS_JSON=${PARAMS_JSON}"
          ls -lah "${PARAMS_JSON}" || true

          echo "use_sandbox in file:"
          jq -r '.use_sandbox // "MISSING"' "${PARAMS_JSON}" || true

          echo "Resolved meta.use_sandbox:"
          printf '%s\n' "${{ steps.meta.outputs.use_sandbox }}"
            
      - name: Select Zenodo base + token (from resolved meta)
        id: zbase
        shell: bash
        env:
          ZENODO_TOKEN: ${{ secrets.ZENODO_TOKEN }}
          ZENODO_SANDBOX_TOKEN: ${{ secrets.ZENODO_SANDBOX_TOKEN }}
        run: |
          set -euo pipefail
          SBX="${{ steps.meta.outputs.use_sandbox }}"
          echo "Resolved use_sandbox = ${SBX}"

          if [[ "${SBX}" == "false" || "${SBX}" == "False" || "${SBX}" == "0" ]]; then
            BASE="https://zenodo.org"
            TOKEN="${ZENODO_TOKEN}"
            MODE="production"
          else
            BASE="https://sandbox.zenodo.org"
            TOKEN="${ZENODO_SANDBOX_TOKEN}"
            MODE="sandbox"
          fi

          if [[ -z "${TOKEN}" ]]; then
            echo "::error ::Missing token for ${MODE}. Set ZENODO_TOKEN or ZENODO_SANDBOX_TOKEN."
            exit 1
          fi

          echo "base=${BASE}"   >> $GITHUB_OUTPUT
          echo "token=${TOKEN}" >> $GITHUB_OUTPUT
          echo "mode=${MODE}"   >> $GITHUB_OUTPUT
          echo "Using Zenodo mode: ${MODE} (${BASE})"

      - name: Verify payload directory and list files
        run: |
          echo "Using payload dir: ${PAYLOAD_DIR}"
          if [ ! -d "${PAYLOAD_DIR}" ]; then
            echo "::error ::Payload directory '${PAYLOAD_DIR}' does not exist at repo root."
            exit 1
          fi
          file_count=$(find "${PAYLOAD_DIR}" -maxdepth 1 -type f | wc -l | tr -d ' ')
          if [ "${file_count}" = "0" ]; then
            echo "::error ::No files found in '${PAYLOAD_DIR}'."
            exit 1
          fi
          echo "Found ${file_count} file(s):"
          ls -lah "${PAYLOAD_DIR}"

      - name: Create deposition
        id: dep
        run: |
          BASE="${{ steps.zbase.outputs.base }}"
          TOKEN="${{ steps.zbase.outputs.token }}"

          KWCSV='${{ steps.meta.outputs.keywords_csv }}'
          KEYWORDS_JSON=$(jq -cn --arg kw "$KWCSV" '$kw | split(",") | map(gsub("^\\s+|\\s+$"; "")) | map(select(length>0))')

          META=$(jq -n \
            --arg title '${{ steps.meta.outputs.title }}' \
            --arg desc  '${{ steps.meta.outputs.description }}' \
            --arg comm  '${{ steps.meta.outputs.community }}' \
            --arg creator '${{ steps.meta.outputs.creator }}' \
            --arg affil   '${{ steps.meta.outputs.affiliation }}' \
            --arg orcid   '${{ steps.meta.outputs.orcid }}' \
            --arg lic     '${{ steps.meta.outputs.license }}' \
            --argjson keywords "$KEYWORDS_JSON" \
            '{
               metadata: {
                 title: $title,
                 upload_type: "dataset",
                 description: $desc,
                 creators: (
                   if ($orcid | length) > 0 then
                     [{name:$creator, affiliation:$affil, orcid:$orcid}]
                   else
                     [{name:$creator, affiliation:$affil}]
                   end
                 ),
                 communities: [{identifier:$comm}],
                 keywords: $keywords,
                 related_identifiers: [
                   {identifier:"10.5281/zenodo.16256961", relation:"isDerivedFrom", scheme:"doi"}
                 ],
                 access_right: "open",
                 license: $lic
               }
             }')

          echo "Creating deposition…"
          RES=$(curl -sS -X POST "$BASE/api/deposit/depositions" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $TOKEN" \
              -d "$META")
          echo "$RES" > dep.json

          dep_id=$(jq -r '.id // empty' dep.json)
          bucket=$(jq -r '.links.bucket // empty' dep.json)

          if [ -z "$dep_id" ] || [ -z "$bucket" ]; then
            echo "::error ::Failed to create deposition. Response:"
            cat dep.json
            exit 1
          fi

          echo "id=$dep_id"     >> $GITHUB_OUTPUT
          echo "bucket=$bucket" >> $GITHUB_OUTPUT

      - name: Upload files
        run: |
          set -euo pipefail
          TOKEN="${{ steps.zbase.outputs.token }}"
          echo "Uploading from ${PAYLOAD_DIR}…"
          while IFS= read -r -d '' f; do
            base=$(basename "$f")
            echo "Uploading: $base"
            curl -sS --fail -H "Authorization: Bearer $TOKEN" \
                 --upload-file "$f" "${{ steps.dep.outputs.bucket }}/$base"
          done < <(find "${PAYLOAD_DIR}" -maxdepth 1 -type f -print0)

      - name: Publish deposition
        id: publish
        run: |
          BASE="${{ steps.zbase.outputs.base }}"
          TOKEN="${{ steps.zbase.outputs.token }}"
          echo "Publishing deposition ${{ steps.dep.outputs.id }}…"
          RES=$(curl -sS -X POST "$BASE/api/deposit/depositions/${{ steps.dep.outputs.id }}/actions/publish" \
                 -H "Authorization: Bearer $TOKEN")
          echo "$RES" > pub.json

          doi=$(jq -r '.metadata.doi // empty' pub.json)
          record=$(jq -r '.links.record_html // empty' pub.json)

          if [ -z "$doi" ] || [ -z "$record" ]; then
            echo "::error ::Publish failed. Response:"
            cat pub.json
            exit 1
          fi

          echo "doi=$doi"      >> $GITHUB_OUTPUT
          echo "record=$record" >> $GITHUB_OUTPUT

      - name: Output links
        run: |
          echo "Record: ${{ steps.publish.outputs.record }}"
          echo "DOI:    ${{ steps.publish.outputs.doi }}"
